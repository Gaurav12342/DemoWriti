{"ast":null,"code":"var _jsxFileName = \"/home/gauravpendherkar/DemoWriti/src/containers/UserAuth/SwitchHome/index.js\";\nimport React, { useState, useEffect } from 'react';\nimport { withRouter } from 'react-router-dom';\nimport { connect } from 'react-redux';\nimport SwitchHomeUI from './SwitchHome';\nimport SecurityModal from './SecurityModal';\nimport { createForm } from 'rc-form';\nimport { SET_USER_DATA, SET_HOME_ID } from '../../../appRedux/ActionTypes';\nimport { setUserData, setReduxHomeId } from '../../../appRedux/actions/Auth';\nimport { resetResident } from '../../../appRedux/actions/Resident';\nimport { verifyOtp, resendOtpLink } from '../../../services/api/routes/auth';\nimport { decryptData, encryptData } from '../../../util/Crypto';\nimport { prepareUserData } from '../../../services/api/services/Auth';\nimport { Toast } from '../../../components/common/Toast';\nimport { setHomeId } from '../../../services/api/routes/auth';\nimport UtilService from '../../../util/common';\nimport { getUserDetail } from '../../../services/DBService/auth';\nimport axios from '../../../services/api/config';\n\nconst _ = require('lodash');\n\nlet title = {\n  password: 'Enter Password',\n  otp: 'Enter Security Code'\n};\n\nfunction SwitchHome({\n  authUser,\n  homeId,\n  ...props\n}) {\n  const [options, setOptions] = useState([]);\n  const [isModalVisible, setModalVisible] = useState(false);\n  const [modalTitle, setModalTitle] = useState(title.password);\n  const [forPassword, setforPassword] = useState(true);\n  const [okBtnLoading, setBtnLoading] = useState(false);\n  const [excludeOTPVerification, setExcludeOTPVerification] = useState(false);\n  const [changeHomeDetail, setChangeHomeDetail] = useState(undefined);\n  const [count, setCount] = useState(0);\n  const [curHomeId, setCurHomeId] = useState(homeId);\n  const [showPass, setShowPass] = useState(false);\n  useEffect(() => {\n    if (authUser && authUser.homeId && authUser.homeId._id) {\n      props.setReduxHomeId(SET_HOME_ID, authUser.homeId._id);\n    }\n  }, [authUser]);\n  useEffect(() => {\n    let tempOptions = [];\n\n    if (authUser && authUser.homeList && authUser.homeList.length > 0) {\n      authUser.homeList.forEach(obj => {\n        tempOptions.push({\n          label: obj.name,\n          id: obj._id,\n          key: obj._id\n        });\n      });\n      setOptions(tempOptions);\n    }\n  }, []);\n\n  const handleModalSubmit = () => {\n    if (forPassword) {\n      handlePasswordSubmit();\n    } else {\n      handleSubmitOtp();\n    }\n  };\n\n  const handleModalClose = () => {\n    props.form.resetFields();\n    setforPassword(true);\n    setExcludeOTPVerification(false);\n    setModalTitle(title.password);\n    setCount(0);\n    setModalVisible(false);\n  };\n\n  const handlePasswordSubmit = async () => {\n    let request = getRequest();\n\n    if (request) {\n      handleSetHomeId(request);\n    }\n  };\n\n  const getRequest = () => {\n    const {\n      validateFields\n    } = props.form;\n    let request = {};\n    request.homeId = homeId;\n    request.password = '';\n    validateFields((err, values) => {\n      console.log('TCL: getRequest -> err', err);\n\n      if (err) {\n        request = null;\n        return;\n      }\n\n      request.password = values.password;\n    });\n    return request;\n  };\n\n  const handleSubmitOtp = event => {\n    const {\n      validateFields\n    } = props.form;\n    validateFields(async (err, values) => {\n      if (err) {\n        return;\n      }\n\n      setBtnLoading(true);\n\n      if (values.otp) {\n        axios({ ...verifyOtp,\n          data: { ...values\n          }\n        }).then(({\n          data\n        }) => {\n          if (data.code === 'OK') {\n            Toast.success(`${data.message}`);\n\n            if (changeHomeDetail) {\n              updateHomeData(changeHomeDetail);\n            }\n          }\n\n          handleModalClose();\n          setBtnLoading(false);\n        }).catch(error => {\n          setBtnLoading(false);\n        });\n      }\n    });\n  };\n\n  const startTimer = () => {\n    var timeLeft = 60;\n    var timerid = setInterval(countdown, 1000);\n\n    function countdown() {\n      if (timeLeft == 0) {\n        clearTimeout(timerid);\n        setCount(0);\n      } else {\n        setCount(timeLeft);\n        timeLeft--;\n      }\n    }\n  };\n\n  const manageUserData = data => {\n    let oldUserData = _.cloneDeep(decryptData(localStorage.getItem('user')));\n\n    data = { ...oldUserData,\n      ...data\n    };\n    localStorage.setItem('user', encryptData(data));\n  };\n\n  const updateHomeData = data => {\n    props.setReduxHomeId(SET_HOME_ID, curHomeId);\n    manageUserData(data);\n    localStorage.removeItem('mappedModulePermissions');\n    localStorage.removeItem('mappedSubModulePermissions');\n    localStorage.removeItem('rolePemissionModules');\n    axios.defaults.headers.common['homeId'] = data.homeId._id;\n\n    if (data && data.homeId && data.homeId.homeIdentifier) {\n      localStorage.setItem('tenantId', data.homeId.homeIdentifier);\n      axios.defaults.headers.common['homeIdentifier'] = data.homeId.homeIdentifier;\n      localStorage.setItem('homeId', data.homeId._id);\n      axios.defaults.headers.common['homeId'] = data.homeId._id;\n    }\n\n    if (!data.homeId.homeIdentifier) {\n      localStorage.setItem('tenantId', '');\n    }\n\n    updateUserData(data); // props.history.push('/') commented because it will redirect to default resident screen\n    // props.history.push(props.location.pathname) commented because for same route it wont refresh screen\n\n    window.location.reload();\n    resetResident();\n  };\n\n  const handleSetHomeId = request => {\n    request.homeId = curHomeId || request.homeId;\n    setBtnLoading(true);\n    axios({ ...setHomeId,\n      data: { ...request,\n        excludeOTPVerification: false\n      }\n    }).then(async ({\n      data\n    }) => {\n      if (data.code === 'OK') {\n        let userDetail = await getUserDetail({\n          email: UtilService.getPrimaryValue(authUser === null || authUser === void 0 ? void 0 : authUser.emails, 'email')\n        });\n\n        if (userDetail.excludeOTPVerification || authUser.excludeOTPVerification) {\n          updateHomeData(data.data);\n          handleModalClose();\n        } else {\n          setChangeHomeDetail(data.data);\n        }\n\n        setExcludeOTPVerification(userDetail.excludeOTPVerification);\n\n        if (!authUser.excludeOTPVerification && !userDetail.excludeOTPVerification) {\n          setforPassword(false);\n          setModalTitle(title.otp);\n          startTimer();\n        }\n\n        Toast.success(data.message);\n        props.form.resetFields();\n        props.socket.disconnect();\n        props.socket.connect();\n      } else {\n        Toast.error(data.message);\n      }\n\n      setBtnLoading(false);\n    }).catch(error => {\n      setBtnLoading(false);\n    });\n  };\n\n  const updateUserData = data => {\n    let user = decryptData(localStorage.getItem('user'));\n    user = { ...user,\n      ...data\n    };\n    user = prepareUserData(user);\n    localStorage.setItem('user', encryptData(user));\n    props.setUserData(SET_USER_DATA, user);\n  };\n\n  function handleOptionChange(e) {\n    setModalVisible(true);\n  }\n\n  const handleHomeChange = val => {\n    // props.setReduxHomeId(SET_HOME_ID, val)\n    setCurHomeId(val);\n    setModalVisible(true);\n  };\n\n  const handleResentLink = () => {\n    axios({ ...resendOtpLink\n    }).then(({\n      data\n    }) => {\n      startTimer();\n    });\n  };\n\n  return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(SwitchHomeUI, {\n    className: \"inputForm select\",\n    placeholder: \"Select Home\",\n    options: options,\n    value: homeId,\n    authUser: authUser,\n    onChange: handleOptionChange,\n    onHomeChange: handleHomeChange,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 229,\n      columnNumber: 7\n    }\n  }), isModalVisible ? /*#__PURE__*/React.createElement(SecurityModal, {\n    visible: isModalVisible,\n    title: modalTitle,\n    form: props.form,\n    okBtnLoading: okBtnLoading,\n    forPassword: forPassword,\n    onCancel: handleModalClose,\n    onClose: handleModalClose,\n    onOk: handleModalSubmit,\n    count: count,\n    onResentLink: handleResentLink,\n    excludeOTPVerification: excludeOTPVerification,\n    showPass: showPass,\n    onHideShowPassChange: () => setShowPass(showPass => !showPass),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 239,\n      columnNumber: 9\n    }\n  }) : null);\n}\n\nconst mapStateToProps = ({\n  auth,\n  commonData\n}) => {\n  const {\n    authUser,\n    homeId\n  } = auth;\n  const {\n    socket\n  } = commonData;\n  return {\n    authUser,\n    socket,\n    homeId\n  };\n};\n\nexport default connect(mapStateToProps, {\n  setUserData,\n  setReduxHomeId,\n  resetResident\n})(createForm('SwitchHome')(withRouter(SwitchHome)));","map":{"version":3,"sources":["/home/gauravpendherkar/DemoWriti/src/containers/UserAuth/SwitchHome/index.js"],"names":["React","useState","useEffect","withRouter","connect","SwitchHomeUI","SecurityModal","createForm","SET_USER_DATA","SET_HOME_ID","setUserData","setReduxHomeId","resetResident","verifyOtp","resendOtpLink","decryptData","encryptData","prepareUserData","Toast","setHomeId","UtilService","getUserDetail","axios","_","require","title","password","otp","SwitchHome","authUser","homeId","props","options","setOptions","isModalVisible","setModalVisible","modalTitle","setModalTitle","forPassword","setforPassword","okBtnLoading","setBtnLoading","excludeOTPVerification","setExcludeOTPVerification","changeHomeDetail","setChangeHomeDetail","undefined","count","setCount","curHomeId","setCurHomeId","showPass","setShowPass","_id","tempOptions","homeList","length","forEach","obj","push","label","name","id","key","handleModalSubmit","handlePasswordSubmit","handleSubmitOtp","handleModalClose","form","resetFields","request","getRequest","handleSetHomeId","validateFields","err","values","console","log","event","data","then","code","success","message","updateHomeData","catch","error","startTimer","timeLeft","timerid","setInterval","countdown","clearTimeout","manageUserData","oldUserData","cloneDeep","localStorage","getItem","setItem","removeItem","defaults","headers","common","homeIdentifier","updateUserData","window","location","reload","userDetail","email","getPrimaryValue","emails","socket","disconnect","user","handleOptionChange","e","handleHomeChange","val","handleResentLink","mapStateToProps","auth","commonData"],"mappings":"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","sourcesContent":["import React, { useState, useEffect } from 'react';\nimport { withRouter } from 'react-router-dom';\nimport { connect } from 'react-redux';\nimport SwitchHomeUI from './SwitchHome';\nimport SecurityModal from './SecurityModal';\nimport { createForm } from 'rc-form';\nimport { SET_USER_DATA, SET_HOME_ID } from '../../../appRedux/ActionTypes';\nimport { setUserData, setReduxHomeId } from '../../../appRedux/actions/Auth';\nimport { resetResident } from '../../../appRedux/actions/Resident';\nimport { verifyOtp, resendOtpLink } from '../../../services/api/routes/auth';\nimport { decryptData, encryptData } from '../../../util/Crypto';\nimport { prepareUserData } from '../../../services/api/services/Auth';\nimport { Toast } from '../../../components/common/Toast';\nimport { setHomeId } from '../../../services/api/routes/auth';\nimport UtilService from '../../../util/common';\nimport { getUserDetail } from '../../../services/DBService/auth';\nimport axios from '../../../services/api/config';\nconst _ = require('lodash');\n\nlet title = {\n  password: 'Enter Password',\n  otp: 'Enter Security Code',\n};\nfunction SwitchHome({ authUser, homeId, ...props }) {\n  const [options, setOptions] = useState([]);\n  const [isModalVisible, setModalVisible] = useState(false);\n  const [modalTitle, setModalTitle] = useState(title.password);\n  const [forPassword, setforPassword] = useState(true);\n  const [okBtnLoading, setBtnLoading] = useState(false);\n  const [excludeOTPVerification, setExcludeOTPVerification] = useState(false);\n  const [changeHomeDetail, setChangeHomeDetail] = useState(undefined);\n  const [count, setCount] = useState(0);\n  const [curHomeId, setCurHomeId] = useState(homeId);\n  const [showPass, setShowPass] = useState(false);\n\n  useEffect(() => {\n    if (authUser && authUser.homeId && authUser.homeId._id) {\n      props.setReduxHomeId(SET_HOME_ID, authUser.homeId._id);\n    }\n  }, [authUser]);\n\n  useEffect(() => {\n    let tempOptions = [];\n    if (authUser && authUser.homeList && authUser.homeList.length > 0) {\n      authUser.homeList.forEach((obj) => {\n        tempOptions.push({ label: obj.name, id: obj._id, key: obj._id });\n      });\n      setOptions(tempOptions);\n    }\n  }, []);\n  const handleModalSubmit = () => {\n    if (forPassword) {\n      handlePasswordSubmit();\n    } else {\n      handleSubmitOtp();\n    }\n  };\n  const handleModalClose = () => {\n    props.form.resetFields();\n    setforPassword(true);\n    setExcludeOTPVerification(false);\n    setModalTitle(title.password);\n    setCount(0);\n    setModalVisible(false);\n  };\n  const handlePasswordSubmit = async () => {\n    let request = getRequest();\n    if (request) {\n      handleSetHomeId(request);\n    }\n  };\n  const getRequest = () => {\n    const { validateFields } = props.form;\n    let request = {};\n    request.homeId = homeId;\n    request.password = '';\n    validateFields((err, values) => {\n      console.log('TCL: getRequest -> err', err);\n      if (err) {\n        request = null;\n        return;\n      }\n      request.password = values.password;\n    });\n    return request;\n  };\n  const handleSubmitOtp = (event) => {\n    const { validateFields } = props.form;\n    validateFields(async (err, values) => {\n      if (err) {\n        return;\n      }\n\n      setBtnLoading(true);\n      if (values.otp) {\n        axios({ ...verifyOtp, data: { ...values } })\n          .then(({ data }) => {\n            if (data.code === 'OK') {\n              Toast.success(`${data.message}`);\n              if (changeHomeDetail) {\n                updateHomeData(changeHomeDetail);\n              }\n            }\n            handleModalClose();\n            setBtnLoading(false);\n          })\n          .catch((error) => {\n            setBtnLoading(false);\n          });\n      }\n    });\n  };\n  const startTimer = () => {\n    var timeLeft = 60;\n    var timerid = setInterval(countdown, 1000);\n    function countdown() {\n      if (timeLeft == 0) {\n        clearTimeout(timerid);\n        setCount(0);\n      } else {\n        setCount(timeLeft);\n        timeLeft--;\n      }\n    }\n  };\n  const manageUserData = (data) => {\n    let oldUserData = _.cloneDeep(decryptData(localStorage.getItem('user')));\n    data = { ...oldUserData, ...data };\n    localStorage.setItem('user', encryptData(data));\n  };\n  const updateHomeData = (data) => {\n    props.setReduxHomeId(SET_HOME_ID, curHomeId);\n    manageUserData(data);\n\n    localStorage.removeItem('mappedModulePermissions');\n    localStorage.removeItem('mappedSubModulePermissions');\n    localStorage.removeItem('rolePemissionModules');\n\n    axios.defaults.headers.common['homeId'] = data.homeId._id;\n\n    if (data && data.homeId && data.homeId.homeIdentifier) {\n      localStorage.setItem('tenantId', data.homeId.homeIdentifier);\n      axios.defaults.headers.common['homeIdentifier'] =\n        data.homeId.homeIdentifier;\n\n      localStorage.setItem('homeId', data.homeId._id);\n      axios.defaults.headers.common['homeId'] = data.homeId._id;\n    }\n    if (!data.homeId.homeIdentifier) {\n      localStorage.setItem('tenantId', '');\n    }\n\n    updateUserData(data);\n    // props.history.push('/') commented because it will redirect to default resident screen\n    // props.history.push(props.location.pathname) commented because for same route it wont refresh screen\n    window.location.reload();\n    resetResident();\n  };\n  const handleSetHomeId = (request) => {\n    request.homeId = curHomeId || request.homeId;\n    setBtnLoading(true);\n    axios({\n      ...setHomeId,\n      data: {\n        ...request,\n        excludeOTPVerification: false,\n      },\n    })\n      .then(async ({ data }) => {\n        if (data.code === 'OK') {\n          let userDetail = await getUserDetail({\n            email: UtilService.getPrimaryValue(authUser?.emails, 'email'),\n          });\n          if (\n            userDetail.excludeOTPVerification ||\n            authUser.excludeOTPVerification\n          ) {\n            updateHomeData(data.data);\n            handleModalClose();\n          } else {\n            setChangeHomeDetail(data.data);\n          }\n\n          setExcludeOTPVerification(userDetail.excludeOTPVerification);\n          if (\n            !authUser.excludeOTPVerification &&\n            !userDetail.excludeOTPVerification\n          ) {\n            setforPassword(false);\n            setModalTitle(title.otp);\n            startTimer();\n          }\n\n          Toast.success(data.message);\n          props.form.resetFields();\n          props.socket.disconnect();\n          props.socket.connect();\n        } else {\n          Toast.error(data.message);\n        }\n        setBtnLoading(false);\n      })\n      .catch((error) => {\n        setBtnLoading(false);\n      });\n  };\n  const updateUserData = (data) => {\n    let user = decryptData(localStorage.getItem('user'));\n    user = { ...user, ...data };\n    user = prepareUserData(user);\n    localStorage.setItem('user', encryptData(user));\n    props.setUserData(SET_USER_DATA, user);\n  };\n  function handleOptionChange(e) {\n    setModalVisible(true);\n  }\n  const handleHomeChange = (val) => {\n    // props.setReduxHomeId(SET_HOME_ID, val)\n    setCurHomeId(val);\n    setModalVisible(true);\n  };\n  const handleResentLink = () => {\n    axios({ ...resendOtpLink }).then(({ data }) => {\n      startTimer();\n    });\n  };\n  return (\n    <>\n      <SwitchHomeUI\n        className='inputForm select'\n        placeholder='Select Home'\n        options={options}\n        value={homeId}\n        authUser={authUser}\n        onChange={handleOptionChange}\n        onHomeChange={handleHomeChange}\n      />\n      {isModalVisible ? (\n        <SecurityModal\n          visible={isModalVisible}\n          title={modalTitle}\n          form={props.form}\n          okBtnLoading={okBtnLoading}\n          forPassword={forPassword}\n          onCancel={handleModalClose}\n          onClose={handleModalClose}\n          onOk={handleModalSubmit}\n          count={count}\n          onResentLink={handleResentLink}\n          excludeOTPVerification={excludeOTPVerification}\n          showPass={showPass}\n          onHideShowPassChange={() => setShowPass((showPass) => !showPass)}\n        />\n      ) : null}\n    </>\n  );\n}\n\nconst mapStateToProps = ({ auth, commonData }) => {\n  const { authUser, homeId } = auth;\n  const { socket } = commonData;\n  return { authUser, socket, homeId };\n};\n\nexport default connect(mapStateToProps, {\n  setUserData,\n  setReduxHomeId,\n  resetResident,\n})(createForm('SwitchHome')(withRouter(SwitchHome)));\n"]},"metadata":{},"sourceType":"module"}